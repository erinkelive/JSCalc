<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório de Cálculos Avançado</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .controls { margin-bottom: 15px; }
    .controls label { margin-right: 15px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: right; }
    th { background: #f0f0f0; }
    td.left { text-align: left; }
    .total-row { background: #eef; font-weight: bold; }
    .no-print { display: block; }
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <h1>Relatório de Cálculos - Sexta Parte (Avançado)</h1>
  <div class="controls no-print">
    <!-- Start date and final date inputs. Default values provided for initial testing. -->
    <label>Data Inicial (AAAA-MM): <input type="month" id="startDate" value="2019-02"></label>
    <label>Data Final (AAAA-MM-DD): <input type="date" id="finalDate" value="2025-08-31"></label>
    <label>Valor Base (R$): <input type="number" id="valor" step="0.01" value="480.54"></label>
    <label>Sexta Parte: <input type="number" id="sextaParte" step="0.01" placeholder="auto"></label>
    <br>
    <label><input type="checkbox" id="applyInd" checked> Aplicar Tabela de Índices (TJSP)</label>
    <label><input type="checkbox" id="applySelic" checked> Aplicar Selic</label>
    <label><input type="checkbox" id="applyFerias" checked> Incluir Férias</label>
    <label><input type="checkbox" id="applyTerco" checked> Incluir 1/3 Constitucional</label>
    <label><input type="checkbox" id="applyDecimo" checked> Incluir 13º</label>
    <label><input type="checkbox" id="applyLicPremio" checked> Incluir Licença-Prêmio</label>
    <br>
    <label>Honorários (%): <input type="number" id="honor" step="0.01" value="0"></label>
    <label>Custas (R$): <input type="number" id="custas" step="0.01" value="0"></label>
    <br>
    <button onclick="generateReport()">Gerar</button>
    <button onclick="downloadCSV()">Baixar CSV</button>
    <button onclick="window.print()">Imprimir</button>
  </div>
  <div id="reportContainer"></div>

  <!-- Índices da Tabela TJSP -->
  <script src="tabela_data2.js"></script>
  <!-- Fatores Selic -->
  <script src="selic_data.js"></script>
  <script>
    /**
     * Formata número monetário para pt-BR.
     * @param {number} val
     */
    function formatMoney(val) {
      return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    /**
     * Gera um array de datas mensais entre a data inicial (YYYY-MM) e a data final (YYYY-MM-DD).
     * @param {string} startMonth
     * @param {string} endDate
     */
    function generateDateRange(startMonth, endDate) {
      const dates = [];
      if (!startMonth || !endDate) return dates;
      const [y, m] = startMonth.split('-').map(Number);
      let current = new Date(y, m - 1, 1);
      const end = new Date(endDate);
      end.setDate(1);
      while (current <= end) {
        dates.push(new Date(current.getFullYear(), current.getMonth(), 1));
        current.setMonth(current.getMonth() + 1);
      }
      return dates;
    }

    /**
     * Converte data para chave do dicionário (YYYY-MM).
     * @param {Date} date
     */
    function toKey(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      return `${y.toString().padStart(4, '0')}-${m.toString().padStart(2, '0')}`;
    }

    /**
     * Obtém o fator Selic para uma data específica.
     * A função retorna o fator cuja data de início é a maior data menor ou igual à data informada.
     * Caso nenhuma data seja menor ou igual, retorna 0.
     * @param {Date} date
     */
    // Fator Selic padrão para datas que antecedem a tabela (célula N28 da planilha)
    const selicDefault = (typeof selicFactors !== 'undefined' && selicFactors.length > 0) ? selicFactors[0].factor : 0;

    function getSelicFactor(date) {
      // selicFactors deve estar ordenado por data ascendente.
      let factor = 0;
      const dISO = date.toISOString().split('T')[0];
      for (let i = 0; i < selicFactors.length; i++) {
        if (selicFactors[i].date <= dISO) {
          factor = selicFactors[i].factor;
        } else {
          break;
        }
      }
      // se nenhum fator encontrado (factor=0), usar o padrão (como na planilha, N28)
      if (factor === 0) {
        return selicDefault;
      }
      return factor;
    }

    /**
     * Gera o relatório completo, preenchendo a tabela na página.
     */
    function generateReport() {
      const startMonth = document.getElementById('startDate').value;
      const finalDate = document.getElementById('finalDate').value;
      const baseValue = parseFloat(document.getElementById('valor').value);
      const sextaVal = document.getElementById('sextaParte').value ? parseFloat(document.getElementById('sextaParte').value) : null;
      const applyInd = document.getElementById('applyInd').checked;
      const applySelic = document.getElementById('applySelic').checked;
      const applyFerias = document.getElementById('applyFerias').checked;
      const applyTerco = document.getElementById('applyTerco').checked;
      const applyDecimo = document.getElementById('applyDecimo').checked;
      const applyLic = document.getElementById('applyLicPremio').checked;
      const honorPct = parseFloat(document.getElementById('honor').value) || 0;
      const custas = parseFloat(document.getElementById('custas').value) || 0;
      if (!startMonth || !finalDate) {
        alert('Preencha as datas inicial e final.');
        return;
      }
      if (isNaN(baseValue) || baseValue <= 0) {
        alert('Valor deve ser positivo.');
        return;
      }
      // Geração das datas
      const dates = generateDateRange(startMonth, finalDate);
      if (dates.length === 0) {
        alert('Período inválido.');
        return;
      }
      // Índice do mês seguinte à data final para Ind Hoje (exceto após 2021-12)
      const lastDate = dates[dates.length - 1];
      const nextMonthDate = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 1);
      const nextKey = toKey(nextMonthDate);
      const indHojeGlobal = tabelaTJSP[nextKey] || 1;
      const sextaParte = sextaVal !== null ? sextaVal : baseValue / 6;
      // arrays de resultados
      const ids = [];
      const indCorrecoes = [];
      const indHoje = [];
      const valAtual = [];
      const ferias = [];
      const terco = [];
      const decimo = [];
      const licPremio = [];
      const fatorSelicArr = [];
      // cálculos linha a linha
      // Férias e Licença precisam lembrar última posição de pagamento
      let lastFerias = -1;
      let lastLic = -1;
      for (let i = 0; i < dates.length; i++) {
        const dt = dates[i];
        ids.push(i + 1);
        // Índices
        let indCorr;
        if (!applyInd) {
          indCorr = 1;
        } else {
          // Tabela TJSP só se data < 2021-12-01
          if (dt >= new Date(2021, 11, 1)) {
            indCorr = 1;
          } else {
            const k = toKey(dt);
            indCorr = tabelaTJSP[k] || 1;
          }
        }
        indCorrecoes.push(indCorr);
        // Índice Hoje
        let indH;
        if (!applyInd) {
          indH = 1;
        } else {
          if (dt >= new Date(2021, 11, 1)) {
            indH = 1;
          } else {
            indH = indHojeGlobal;
          }
        }
        indHoje.push(indH);
        // Valor Atual
        const vA = sextaParte / indCorr * indH;
        valAtual.push(vA);
        // Cálculo de Férias
        let fer = 0;
        if (applyFerias) {
          const monthsSince = lastFerias === -1 ? (i + 1) : (i - lastFerias);
          let hasPrevFerias = false;
          // verifica se há ferias > 0 nas 11 linhas acima
          for (let j = Math.max(0, i - 11); j < i; j++) {
            if (ferias[j] && ferias[j] > 0) { hasPrevFerias = true; break; }
          }
          const endBlock = (i === dates.length - 1);
          if (!hasPrevFerias && (monthsSince >= 12 || endBlock)) {
            fer = vA / 12 * monthsSince;
            lastFerias = i;
          }
        }
        ferias.push(fer);
        // Terço constitucional
        terco.push(applyTerco ? (fer / 3) : 0);
        // 13º salário
        decimo.push(applyDecimo ? fer : 0);
        // Licença-Prêmio
        let lp = 0;
        if (applyLic) {
          const monthsSinceLP = lastLic === -1 ? (i + 1) : (i - lastLic);
          const endBlockLP = (i === dates.length - 1);
          if (monthsSinceLP === 60) {
            lp = vA * 3;
            lastLic = i;
          } else if (endBlockLP && monthsSinceLP > 0) {
            lp = vA * (monthsSinceLP / 20);
            lastLic = i;
          }
        }
        licPremio.push(lp);
        // Fator Selic para esta data
        const fSel = applySelic ? getSelicFactor(dt) : 0;
        fatorSelicArr.push(fSel);
      }
      // construindo a tabela
      let html = '';
      html += '<table><thead><tr>';
      html += '<th class="left">ID</th>';
      html += '<th class="left">Data</th>';
      html += '<th>Valor</th>';
      html += '<th>Sexta Parte</th>';
      html += '<th>Ind. Correção</th>';
      html += '<th>Ind. Hoje</th>';
      html += '<th>Val. Atual</th>';
      html += '<th>Férias</th>';
      html += '<th>1/3</th>';
      html += '<th>13º</th>';
      html += '<th>Lic. Prêmio</th>';
      html += '<th>SubTotal</th>';
      html += '<th>Fator Selic</th>';
      html += '<th>Val. Atualiz. Selic</th>';
      html += '<th>Val. Total</th>';
      html += '</tr></thead><tbody>';
      let tValAtual = 0; let tFerias = 0; let tTerco = 0; let tDecimo = 0; let tLic = 0; let tSub = 0; let tSelic = 0; let tTotal = 0;
      for (let i = 0; i < dates.length; i++) {
        const dt = dates[i];
        const mm = (dt.getMonth() + 1).toString().padStart(2, '0');
        const dtStr = `${dt.getFullYear()}-${mm}`;
        const vA = valAtual[i];
        const f = ferias[i] || 0;
        const ter = terco[i] || 0;
        const dec = decimo[i] || 0;
        const lp = licPremio[i] || 0;
        const sub = vA + f + ter + dec + lp;
        const fSel = fatorSelicArr[i];
        const valSelic = sub * fSel;
        const total = sub + valSelic;
        tValAtual += vA;
        tFerias += f;
        tTerco += ter;
        tDecimo += dec;
        tLic += lp;
        tSub += sub;
        tSelic += valSelic;
        tTotal += total;
        html += '<tr>';
        html += `<td class="left">${ids[i]}</td>`;
        html += `<td class="left">${dtStr}</td>`;
        html += `<td>${formatMoney(baseValue)}</td>`;
        html += `<td>${formatMoney(sextaParte)}</td>`;
        html += `<td>${indCorrecoes[i] ? indCorrecoes[i].toFixed(6) : ''}</td>`;
        html += `<td>${indHoje[i] ? indHoje[i].toFixed(6) : ''}</td>`;
        html += `<td>${formatMoney(vA)}</td>`;
        html += `<td>${f ? formatMoney(f) : ''}</td>`;
        html += `<td>${ter ? formatMoney(ter) : ''}</td>`;
        html += `<td>${dec ? formatMoney(dec) : ''}</td>`;
        html += `<td>${lp ? formatMoney(lp) : ''}</td>`;
        html += `<td>${formatMoney(sub)}</td>`;
        html += `<td>${fSel > 0 ? fSel.toFixed(4) : ''}</td>`;
        html += `<td>${fSel > 0 ? formatMoney(valSelic) : ''}</td>`;
        html += `<td>${formatMoney(total)}</td>`;
        html += '</tr>';
      }
      // Totais
      html += '<tr class="total-row">';
      html += '<td class="left" colspan="6">Totais</td>';
      html += `<td>${formatMoney(tValAtual)}</td>`;
      html += `<td>${formatMoney(tFerias)}</td>`;
      html += `<td>${formatMoney(tTerco)}</td>`;
      html += `<td>${formatMoney(tDecimo)}</td>`;
      html += `<td>${formatMoney(tLic)}</td>`;
      html += `<td>${formatMoney(tSub)}</td>`;
      // Mostra o fator Selic padrão na linha de totais se a opção Selic estiver marcada
      html += `<td>${applySelic ? selicDefault.toFixed(4) : ''}</td>`;
      html += `<td>${applySelic ? formatMoney(tSelic) : ''}</td>`;
      html += `<td>${formatMoney(tTotal)}</td>`;
      html += '</tr>';
      // Honorários
      const honorValue = (honorPct > 0) ? tTotal * (honorPct / 100) : 0;
      const grandTotal = tTotal + honorValue + custas;
      html += '<tr class="total-row">';
      html += `<td class="left" colspan="14">Honorários (${honorPct.toFixed(2)}%)</td>`;
      html += `<td>${honorValue ? formatMoney(honorValue) : ''}</td>`;
      html += '</tr>';
      html += '<tr class="total-row">';
      html += `<td class="left" colspan="14">Custas</td>`;
      html += `<td>${custas ? formatMoney(custas) : ''}</td>`;
      html += '</tr>';
      html += '<tr class="total-row">';
      html += `<td class="left" colspan="14">Total Geral</td>`;
      html += `<td>${formatMoney(grandTotal)}</td>`;
      html += '</tr>';
      html += '</tbody></table>';
      document.getElementById('reportContainer').innerHTML = html;
    }

    /**
     * Exporta a tabela gerada para CSV (se existir).
     */
    function downloadCSV() {
      const table = document.querySelector('#reportContainer table');
      if (!table) {
        alert('Gere a tabela primeiro.');
        return;
      }
      let csv = '';
      const rows = table.querySelectorAll('tr');
      rows.forEach((row) => {
        const cols = row.querySelectorAll('th, td');
        const data = Array.from(cols).map(col => {
          let text = col.innerText.trim();
          // convert pt-BR decimal separators for CSV (comma replaced by dot)
          text = text.replace(/\./g, '').replace(/,/g, '.');
          return text;
        });
        csv += data.join(';') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'relatorio_calculos_avancado.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>